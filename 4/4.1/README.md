# 网络层介绍
+ TCP/IP 协议簇中的网络层负责主机到主机之间的报文传递。
+ 因特网是互联网，是多个 LAN 和 WAN 的组合。

## 网络层服务
+ 分组：网络层负责在源端将负载（从上层接收到的数据）封装进网络层分组并且在目的端从网络层分组中解封负载。换言之，网络层的一个责任是从源端向目的端携带数据而不改变或使用它。
+ 路由：网络层负责将分组从源端路由到目的端路由，网络层负责寻找最佳路由。（通过某些路由协议）
+ 转发：当路由器从它连接的网络接收到一个分组时，它需要将分组转发到另一个所连接的网络上（在单播路由中）或者转发到多个自己所连接到的网络上（在多播路由中）。
+ 差错控制：一般由上层协议提供，也可通过 ICMP 辅助协议提供。
+ 流量控制：一般由上层协议提供，尽量使网络层简单；
+ 拥塞控制：一般由上层协议提供，尽量使网络层简单；
+ 服务质量：绝大多数在上层实现；
+ 安全：IPSec；

## 分组交换
+ 路由器是一个创建了输入端口和输出端口（或一组输出端口）连接的交换机，就像将输入连接到输出电流流动的开关。
+ 数据通信交换技术被分为两大类：电路交换与分组交换。网络层只使用分组交换，因为这一层的数据单位是分组。
+ 在网络层，来自上层的报文被分割成可管理的分组，每个分组从网络中发送。

### 数据报方法：无连接服务
+ 当网络层提供无连接服务时，因特网中每个正在传送的分组都是一个独立的实体；属于同一个报文的多个分组之间没有联系。这种网络中的交换机称为路由器。
+ 每个分组都是基于其头部信息进行路由的：源地址和目的地址。目的地址定义了它应该去哪里，源地址定义了它从哪里来。
+ 在数据报方法中，转发决策基于分组的目的地址。

### 虚电路方法：面向连接服务
+ 在面向连接服务（也称作虚电路方法）中，属于同一报文中的所有分组存在联系。在报文中的所有数据报被发送之前，应该建立虚连接从而定义数据报的路径。在连接建立以后，数据报可以沿着相同的路径发送。在这种类型服务中，分组不仅必须包含源和目的地址，也必须包含流标号，这是一个虚电路标识符，它定义了分组应该经过的路径。
+ 为了创建面向连接服务，使用一个三阶段过程：建立、数据交换和拆除；在虚电路方法中，转发策略基于分组的标签；
+ 建立阶段：
  + 在建立阶段，路由器为虚电路创建了一个表格项；两个辅助分组需要在发送方和接收方之间交换：请求分组与确认分组。
  + 请求分组：一个请求分组从源端发送到目的端。这个辅助分组携带源和目的地址。
  + 确认分组：一种特殊的分组，称为确认分组，它完成了交换表中的表格项。
+ 数据传输阶段：
  + 在所有路由器为特定虚电路创建好它们的转发表之后，属于同一报文的网络层分组可以被一个接一个地发送。
  + 报文中所有的分组都是按照相同的标签序列，并且分组是有序到达目的端的。
+ 拆除阶段：
  + 在拆除阶段，在所有分组发送到 B 之后，源 A 发送一个成为拆除分组的特殊分组。目的 B 以确认分组回复。所有路由器从它们的表格中删除相应的项。

## 网络层性能
从源到目的地分组会遭遇延迟，网络中的延迟可以分为四类：发送延迟、传播延迟、处理延迟以及排队延迟。

### 延迟
+ 发送延迟
  + 一台源主机或路由器不能立即发送分组。发送方需要将分组中的位一个接一个地发到线上。
  + Delay(tr) = (分组长度)/(发送速度)
+ 传播延迟
  + 传播延迟是在传播介质中一个位从 A 点到 B 点所消耗的时间。
  + Delay(pg) = (距离)/(传输速度)
+ 处理延迟
  + 处理延迟是路由器或目的主机从它的输入端接收分组、去除头部、执行差错检测程序并将分组传递到输出端口（在路由器情况下）或将分组传递到上层协议（在目的主机情况下）所需要的时间。
  + Delay(pr) = 在路由器或目的主机中处理分组所需的时间
+ 排队延迟
  + 排队延迟通常在路由器中发生。
  + Delay(qu) = 在路由器中输入和输出队列中分组的等待时间
+ 总延迟 = (n + 1)(Delay-tr + Delay-pg + Delay-pr) + (n)(Delay-qu)

### 吞吐量
+ 网络中任意点的吞吐量被定义为一秒内通过这个点的位的数量，事实上是那一点的数据发送速率(TR)。
+ 吞吐量 = 最小值{TR1, TR2, ···TR-n}

### 分组丢失
+ 另一个严重影响通信性能的问题是发送期间丢失的分组数量（可使用 ACK 机制来防止丢失）。

## 网络层拥塞
我们将拥塞控制机制分为两大类：开环拥塞控制（预防）和闭环拥塞控制（消除）。
+ 开环拥塞控制
  + 重传策略；
  + 窗口策略；
  + 确认策略；
  + 丢弃策略；
  + 许可策略；
+ 闭环拥塞控制：在拥塞发送之后，采用闭环拥塞控制可以缓解拥塞情况。
  + 背压：背压技术是一种控制机制。在这种技术中，一个拥塞点停止接收来自直接上行结点或一些近邻结点的数据。背压技术仅用于虚电路网络。
  + 抑制分组：它是一个分组，该分组由结点发送给源端，通知它发送拥塞的情况。警告报文直接发送给源站点，中间的路由器不进行任何处理。
  + 隐含信令：在隐含信令中，拥塞结点与源端之间或结点与源端之间没有通信。源端能从其他有关征兆中察觉出在网络某处有拥塞（如 ACK 未收到或重复收到）。
  + 显式指令：发生拥塞的结点能发送一种显式信令通知源端或目的端发送了拥塞。在抑制分组方法中，有一个单独的分组用于实现此目的；而在显式信令方法中，信号包含在携带数据的分组中。

## 路由器的结构
我们可以说路由器有四个元件：输入端口、输出端口、路由处理器以及交换结构。