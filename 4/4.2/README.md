# 网络层协议

网络层可以看做是一个主要协议以及三个辅助协议。主要协议即因特网协议第四版（IPv4）负责网络层的分组、转发以及传递。因特网控制报文协议第四版（Internet Control Message Protocol version 4， ICMPv4）帮助 IPv4 处理一些网络层传递中可能发生的错误。因特网组管理协议（Internet Group Management Protocol，IGMP）用于帮助 IPv4 多播。地址解析协议（ARP）用来将网络和数据链路层连接起来。

## IPv4 数据报格式
IP 使用的分组称为数据报（datagram）。包含以下字段：
- 版本号：这 4 位版本号（VER）字段定义 IPv4 协议的版本，值为 4；
- 头部长度：这 4 位头部长度（HLEN）字段以 4 字节定义数据报头部的总长度；
- 服务类型：它定义了数据报如何被处理；
- 总长：这个 16 位字段定义了以字节计算的 IP 数据报总长度（头部加上数据）。
- 标识、标记以及分段偏移：当数据报大于底层网络可以携带的大小时，这三个字段和 IP 数据报的分段有关；
- 生存时间：生存时间（TTL）字段用于控制数据报访问的最大跳数（路由器）；
- 协议：在 TCP/IP 中，分组的数据段称为负载，它从另一个协议中携带整个分组；当源端 IP 当负载被封装到数据报中时，相应协议号被插入到这个字段；当数据报到达目的端，这个字段的值帮助定义负载应该被传递到哪个协议；
- 校验和：IP 使用校验和字段来检查头部，但是不检查负载；
- 源和目的地址：这个 32 位源和目的地址字段分别定义了源端和目的端的 IP 地址；
- 选项：选项可以用来进行网络测试和调试；
- 负载：负载或数据是创建数据报的主要原因，负载是来自使用 IP 服务的其他协议的分组；

### 分段
一个数据报可以通过几个不同的网络进行传输。每一个路由器将它所接收到的帧拆封成 IP 数据报，对它进行处理，然后再将它封装成另外一个帧。

- 最大传输单元（maximum transfer unit, MTU）
  - IP 数据报的最大长度为 65535 字节；
  - 一个数据报可能在到达最终目的端之前被多次分段；
- 与分段相关的字段
  - 标识（identification）：16 位标识字段用于识别一个从源主机发出的数据报；
  - 标记（flag）：最左侧的位是保留位（不使用）。第二位（D位）成为不分段位，用于控制是否进行数据分段；
  - 分段偏移字段（fragmentation offset）：13 位是分段便宜字段标识这个分段在整个数据报中的相对位置。

### IPv4 数据安全
三个安全问题：
- 分组嗅探；
- 分组修改；
- IP 欺骗；

## IPv4 地址
- 本机主机地址：0.0.0.0/32 称为本机主机地址；
- 有限广播地址：255.255.255.255/32 称为有限广播地址。当路由器或主机需要向网络中所有设备发送一个数据报时会使用到这个地址。
- 回送地址：127.0.0.0/8 称为回送地址，这个块中的地址用于测试机器中的一个软件；
- 私有地址：10.0.0.0/8、172.16.0.0/12、192.168.0.0/16、169.254.0.0/16 属于私有地址；
- 多播地址：224.0.0.0/4；

### 动态主机配置协议（DHCP）
- DHCP 在因特网中有广泛的应用，它经常被称为即插即用协议。网络管理员可以配置 DHCP 来将永久 IP 地址分配到主机和路由器上。DHCP 也可以被配置来按需为主机提供临时 IP 地址。第二个功能是为旅行者提供临时 IP 地址。
- DHCP 是一个客户-服务器协议，在发送请求时，源地址为 0.0.0.0（本机），目的地址为255.255.255.255（广播地址），DHCP 协议使用两个熟知端口号 67 和 68 来避免广播响应带来的问题，也会通过事务 ID 来区分不同的响应。
- 差错控制：DHCP 要求 UDP 使用校验和。为了防止几个主机需要重传请求时（例如，在停电之后）造成的拥塞，DHCP 迫使客户使用随机数来设置它的计时器。

### NAT
- 私有网络使用私有地址。将这个网络与全局地址连接在一起的路由器使用一个私有地址和一个全局地址。
- 在最简单的情况下，一个转换表只有两列：私有地址和外部地址（分组的目的地址）。当路由器转换外发分组的源地址时，它也记录其目的地址——分组去往的地方。当响应从目的端返回时，路由器使用分组的源地址（作为外部地址）来找出分组的私有地址。