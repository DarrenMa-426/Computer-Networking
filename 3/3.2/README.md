# 传输层协议

## 简单协议
+ 发送方的传输层从发送方的应用层接收到报文，从中建立一个分组并发送它。接收方的传输层从网络层接收到这个分组，从分组中提取报文并传递到应用层。发送方和接收方的传输层都为应用层提供传输服务。
+ 有限状态机
  + 直到应用层有报文待发送，发送端才发送分组。直到一个分组到达，接收端才将报文传递到它的应用层。
  + 我们可以使用两个有限状态机来表示这些要求，每个有限状态机只有一种状态，即准备状态（ready state）。
  + 发送方状态机保持准备状态，直到一个来自应用层进程的请求到来。当这个事件发生时，发送方状态机将报文封装在分组内，并将其发送到接收方状态机。
  + 接收方状态机保持准备状态，直到一个来自发送方状态机的分组到来。当这个事件发生时，接收方状态机从分组内解封装出报文，并将其发送到应用层进程。
  + UDP 协议是这个协议的轻微改动版本。

## 停止等待协议（发送方和接收方都使用大小为 1 的滑动窗口）
+ 概念
  + 停止-等待协议（Stop-and-Wait-protocol），它使用流量和差错控制；
  + 发送方和接收方都使用大小为 1 的滑动窗口。发送方在某一时刻发送一个分组，并且在发送下一个分组之前等待确认；
  + 为了发送被破坏分组，我们需要在每个数组分组中加入校验和。当一个分组到达接收端时，它就被检测。如果校验和不正确，分组就是被破坏的并被悄悄地丢弃。
  + 接收方的沉默对发送方来说是一种信号，即那个分组不是被破坏就是丢失了。
  + 每当发送方发送一个分组时，它都开启一个计时器。如果在计时器超时之前接收到确认，那么计时器就被关闭并且发送下一个分组（如果它有待发送分组）。
  + 如果计时器超时，发送方就认为分组丢失或被破坏，于是重发之前的分组。这意味着在确认到来之前，发送方都需要存储分组的备份。
+ 序号
  + 协议使用序号和确认号来防止重复分组。一个字段被假如分组头部来保存那个分组的序号。
  + 由于想使分组大小最小化，所以我们寻找能提供无歧义通信的最小的序号范围。
  + 假设我们使用 x 作为序号，我们只需要在之后使用 x + 1，不需要 x + 2。
  + 案例（假设发送端已经发送了带有序号 x 的分组）
    + 1.分组安全完整地到达接收端；接收方发送一个确认。确认到达发送端，使发送端发送下一个序号为 x + 1 的分组；
    + 2.分组被破坏或未到达接收端；发送方在超时后重新发送分组（序号 x）。接收方返回一个确认；
    + 3.分组安全完整到达接收端；接收方发送一个确认，但是确认被破坏或丢失了。发送在超时后重传分组（序号 x）。注意，这里分组是重复的。接收方可以认出这个事实，因为它等待分组 x + 1，但是收到了分组 x；
    + 分析：我们可以看到，由于接收方需要区分情况 1 和 3，因此需要序号 x 和 x + 1.但是不需要一个编号为 x + 2 的分组。在情况 1 中，分组可以再次被编号 x，由于 x 和  x + 1 被确认，两端都不会产生歧义。在情况 2 和 3 中，新的分组是 x + 1 而不是 x + 2。如果仅仅需要 x 和 x + 1，我们可以令 x = 0 且 x + 1 = 1。这意味着序号是 0、1、0、1、0，等额定，这称为模 2 运算。
+ 确认号
  + 在停止-等待协议中，确认号总是以模 2 运算的方式声明预期接收的下一个分组序号。
+ 效率
  + 如果我们的信道又粗（thick）又长（long），那么停止-等待协议将非常低效。对于粗信道，我们的意思是信道有很大的带宽（高数据速率）；对于长信道，我们的意思是往返时间很长。这两者的乘积成为带宽延迟乘积（bandwidth-delay product）。
+ 停止-等待协议实际上是一种回退 N 帧协议，这种回退 N 帧协议只有两个序号且发送窗口大小为 1。

## 回退 N 帧协议（GBN，Go Back N Protocol）

## 选择性重复协议（SR，Select Repeat Protocol）
+ 窗口
  + 选择性重复发送窗口要比回退 N 帧协议要小。
  + 选择性重复接收窗口与回退 N 帧中的接收窗口完全不同。接收窗口的大小和发送窗口等大。选择性重复协议允许和接收窗口一样多的分组失序到来并被存储，直到有一组连续分组被传递到应用层。
+ 确认
  + 在选择性重复协议中，确认号定义了已被接收的无错分组的序号。
+ 在选择性重复中，发送方和接收方窗口的大小最多为 2 的 m 次方的一半。

## 双向协议：捎带
+ 在现实生活中，数据分组通常是双向流动的：从客户到服务器以及从服务器到客户。这意味着确认也需要沿着两个方向流动。一种称为捎带的技术被用来提高双向协议的效率。
+ 当一个分组携带数据从 A 到 B 时，它也携带了确认反馈，这些信息确认了来自 B 的分组已到达；当一个分组携带数据从 B 到 A 时，它也携带了确认反馈，这些信息确认了来组 A 的分组已到达。