# 协议分层
## 概念
+ 协议（protocol）定义了发送者、接收者和所有中间设备为了高效通信需要遵循的规则。当通信复杂时，我们可能需要把任务划分到不同层，每层需要一个协议，也就是说需要协议分层（protocol layering）。
+ 协议分层具有模块化的特点，模块化意味着独立的层次。一层（一个模块）可以定义为一个具有输入和输出的黑盒子，我们不必关心输入如何变成输出。如果给定相同的输入，两台机器提供相同的输出，那么它们可以相互替换。
+ 协议分层的优越性之一是它允许我们将服务从实现中分离出来。一层需要能够接受较低层的一系列服务，同时向较高层提供服务，而我们不关心这一层是如何实现的。
+ 协议分层的两个原则
  + 如果想要双向通信，那么我们需要每一层能够实现两个相反的任务，每一个方向上一个。
  + 两端每一层上的两个对象应该相同。

## TCP/IP 协议簇
+ TCP/IP（Transmission Control Protocol/Internet Protocol，传输控制协议/互联网协议）是目前 Internet 使用的一个协议簇（按不同层次组织的协议集）。它是由相互交互的模块组成的一个层次结构协议，每一个模块提供特定的功能。层次意味着较上层次的协议需要得到一个或多个较下层次协议提供的服务支持。目前 TCP/IP 通常是一个 5 层模型（应用层、传输层、网络层、数据链路层、物理层）。
+ 应用层、传输层和网络层的任务是端到端的（end-to-end）；数据链路层和物理层的任务是点到点的（hop-to-hop），其中一个跳步是一个主机或路由器。也就是说，高三层的任务范围是互联网，低两层的任务范围是链路。
+ 应用层对等体：消息；传输层对等体：段或用户数据报；网络层对等体：数据报；数据链路层对等体：帧；物理层对等体：位。
+ 五个层次
  + 应用层的通信处于两个进程（该层正在运行的两个程序）之间。为了进行通信，一个进程向另一个进程发送请求，并且接受另一个进程的响应。
  + 传输层的逻辑连接也是端到端的。源主机的传输层从应用层得到消息，封装成传输层的分组（称为段或用户数据报，不同协议叫法不同），然后进行发送。通过逻辑（想象的）连接，分组到达目的主机的传输层。
  + 网络层负责在源计算机和目的计算机之间创建一个连接。网络层的通信是主机到主机的。可是，由于从源主机到目的主机可能存在多个路由器，因此路径上的路由器负责为每个分组选择最好的路径。我们可以说网络层负责主机到主机的通信，并且只会分组通过合适的路由器。
  + 数据链路层没有任何特定的协议，它支持所有标准的和私有的协议。能够接管数据报并携带它通过链路的任何协议都能满足网络层的要求。数据链路层接管一个数据报并将它封装在一个称为帧（frame）的分组中。互联网是多个链路（LAN 和 WAN）通过路由器连接而构成的，从主机传输数据到目的地可能存在多个交叠的连路基。路由器负责选择最好的链路进行传输。可是，当路由器定好需要传输的下一条链路后，数据链路层接管这个数据报并使它穿过这条链路。这条链路可以是一个具有链路层交换机的有线局域网、一个无线局域网、一个有限广域网或者一个无线广域网。数据链路层需要负责通过链路传输分组。
  + 物理层负责携带一个帧中单独的比特穿过链路。尽管物理层位于 TCP/IP 协议簇的最底层。但是由于在物理层之下存在另外一个隐藏的传输介质层，因此两个设备物理层之间的通信仍然是逻辑通信。两个设备物理层之间的逻辑单元是一个比特（bit）。
+ Internet 的应用层协议
  + 超级文本传输协议（Hypertext Transfer Protocol, HTTP）是访问万维网（World Wide Web，WWW）的载体。
  + 简单邮件传输协议（Simple Mail Transfer Protocol, SMTP）是电子邮件（e-mail）服务的主要协议。
  + 文件传输协议（File Transfer Protocol, FTP）用于将文件从一台主机传输到另一台主机。
  + 远程登录（Terminal Network, TELNET）和安全外壳（Secure Shell, SSH）用于访问远端的站点。
  + 管理员使用简单网络协议（Simple Network Management Protocol, SNMP）对 Internet 全局或局部进行管理。
  + 域名系统（Domain Name System, DNS）使其他的协议能够查询一台计算机的网络层协议。
  + 因特网管理协议（Internet Group Management Protocol, IGMP）用于管理一个组的成员资格。
+ Internet 的传输层协议
  + 传输控制协议（Transmission Control Protocol, TCP）是一个面向连接的协议，它在传输数据之前，首先在两台主机的传输层之间建立一条逻辑连接。TCP 协议在两个 TCP 层之间创建一个管道，以便传输字节流。
  + 用户数据报协议（User Datagram Protocol, UDP）是一种无连接协议，它传输用户数据报之前不需要创建逻辑连接。在 UDP 中，每个用户数据报是一个独立的实体，它和前一个和后一个用户数据报没有关系（无连接就是这个意思）。
  + 流控制传输协议（Stream Control Transmission Protocol, SCTP）是一种新协议，它是为多媒体出现的新应用设计的。
+ Internet 的网络层协议
  + 因特网协议（Internet Protocol， IP）定义了在网络层称为数据报的分组格式。IP 同时定义了在这一层使用的地址格式和结构。与此同时，IP 负责把源主机把一个分组路由到目的主机。IP 是一个无连接的协议，不提供流量控制、差错控制和拥塞控制服务。这意味着如果一个应用需要这些服务，那么应用需要依赖于传输层协议。
  + 因特网控制报文协议（Internet Control Message Protocol, ICMP）帮助 IP 报告遇到的问题。
  + 因特网组管理协议（Internet Group Management Protocol, IGMP）协助 IP 进行多任务处理。
  + 动态主机配置协议（Dynamic Host Configuration Protocol, DHCP）帮助 IP 获取一台主机的网络层地址。
  + 在网络层地址已知时，地址解析协议（Address Resolution Protocol, ARP）帮助 IP 寻找一台主机或一台路由器的链路层地址。

## 封装与解封装
在 Internet 协议分层中，一个重要的概念是封装/解封装。
+ 源主机的封装
  + 在应用层，交换的数据称为消息（message）。消息通常不包含任何头部和尾部，但是即使包含了这些，我们也将其整体称为消息。消息会被传递到传输层。
  + 传输层把这个消息作为有效载荷，该载荷是传输层应该关注的负载。传输层在有效载荷基础上增加传输层头部，其中包括了希望进行通信的源和目的应用程序的标识符和一些投递该消息需要的更多信息，其结果为一个传输层分组，该分组在 TCP 中成为段（segment），在 UDP 中称为用户数据报（user datagram），然后传输层传递该分组到网络层。
  + 网络层把传输层分组作为数据或有效载荷，并且在该有效载荷上添加自己的头部。头部包含源和目的主机的地址，以及用于头部差错检查、分片的信息等其他一些信息。其结果为一个称为数据报（datagram）的网络层分组。然后，网络层传递这个分组到数据链路层。
  + 数据链路层把网络层分组作为数据或有效载荷，并且添加上自己的头部。该头部包括主机或下一条不（路由器）的链路层地址。其结果为一个成为帧（frame）的链路层分组。该帧被传递到物理层进行传输。
+ 路由器的解封装与封装
  + 在比特集被投递到数据链路层后，这一层从帧中解封装出数据报并将它投递到网络层。
  + 网络层只检查数据报头部的源地址和目的地址，查阅它的转发表以寻找该数据报将被投递到的下一跳步。然后，数据报被传递到下一链路的数据链路层。
  + 下一链路的数据链路层将数据报封装成一个帧，将其传递到物理层进行传输。
+ 目的主机的解封装
  + 在目的主机端，每层都只解封装接收到的分组，移出有效载荷，并将有效载荷传递至较高一层，直到消息到达应用层。（主机中的解封装包含差错检查）

## 地址
TCP/IP 协议分层模型中一堆层次之间存在逻辑通信，包含双方的任何通信都需要两个地址：源地址和目的地址。（物理层的数据交换单元是一个比特，它绝对没有地址）
+ 在应用层，我们通常使用一个像 someorg.com 的名字定义提供服务的站点，或者使用像 somebody@coldmail.com 一样的电子邮件地址。
+ 在传输层，地址称为端口号，这些端口号指定源和目的地的应用层程序。端口号是本地地址，用于区分同一时间运行的几个程序。
+ 网络层地址是全局的，其范围涵盖了整个 Internet。
+ 链路层地址有时叫做 MAC 地址（MAC address），是本地定义的地址。每个链路层地址用于在网络（LAN 或 WAN）中定义一个特定的主机或路由器。

## 多路复用与多路分解
+ 由于 TCP/IP 协议簇在一些层次使用多个协议，因此我们在源端需要进行多路复用（multiplexing），在目的端需要进行多路分解（demultiplexing）。在这种情况下，多路复用的意思是一个协议能够封装来自多个上层协议的分组（一次一个）；多路分解的意思是一个协议能够解封装，并且将分组投递到多个上层协议（一次一个）。
+ 在传输层，无论 UDP 还是 TCP 多可以接受多个应用层协议的消息。在网络层，IP 可以接收来自 TCP 的段也可以接收来自 UDP 的用户数据报。